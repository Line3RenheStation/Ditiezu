<!doctype html>
<html lang="zh-CN zh">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0" name="viewport">
    <meta content="ie=edge" http-equiv="X-UA-Compatible">
    <title>Thread Display</title>
    <link href="./styles.css" rel="stylesheet">
    <script src="main.js"></script>
</head>
<body>
</body>
<script>
    window.curPage = 0;
    window.lastPage = 0;
    window.darkMode = (type) => {
        if (type)
            document.body.classList.add("darkmode");
        else
            document.body.classList.remove("darkmode");
    };
    window.loadPage = (string = undefined) => {
        document.body.innerHTML = "";
        window.page = new DOMParser().parseFromString(string || android.getLoadedPage(), "text/html").children[0];
        window.isLogIn = android.checkLogin();
        let container = document.body.appendNewChild({type: "div", attr: [["id", "content"]]});
        if (page.$("#pgt .pg>*").length !== 0) {
            window.curPage = Int([...page.$("#pgt .pg>*")].filter(i => i.tagName === "STRONG")[0].innerHTML);
            window.lastPage = [...page.$("#pgt .pg>*:not(.nxt)")].last().innerHTML;
            window.lastPage = Int(lastPage.includes("...") ? lastPage.substr(4) : lastPage)
        } else {
            window.curPage = 1;
            window.lastPage = 1
        }
        page.$("[id^='pid']").forEach(reply => {
            let replyThreadContainer = container.appendNewChild({type: "div", attr: [["class", "threadContainer"]]});
            replyThreadContainer.appendNewChild({
                type: "img",
                attr: [["class", "threadMeta_AuthorAvatar"], ["src", reply.$(".avatar img")[0].src], ["onerror", "this.src='noavatar_middle.jpg';"]]
            });
            replyThreadContainer.appendNewChild({
                type: "div",
                attr: [["class", "threadMeta_Container"]],
                innerHTML: `<p class="threadMeta_AuthorName">${reply.$('.pi .authi a')[0].innerText}</p><p class="threadMeta_PostMeta">${reply.$("p em")[0].innerText} · ${reply.$(".pi strong")[0].innerText} · ${reply.$('.pi [id^="authorposton"]')[0].innerText}</p>`
            });
            replyThreadContainer.appendNewChild({
                type: "div",
                attr: [["class", "threadContent"]],
                innerHTML: reply.$(".t_fsz")[0].innerHTML.replace("src=\"static/image/common/none.gif\"", "src='imageAssets\\imageHolder.svg'")
            });
        });

        document.querySelectorAll("img[zoomfile]").forEach(e => {
            let image = new Image();
            image.src = e.attributes["file"].value;
            image.onload = () => {
                e.src = e.attributes["file"].value;
            };
            image.onerror = () => {
                e.src = `imageAssets\\imageBrokenHolder.svg`;
            };
        });

        document.querySelectorAll(".locked").forEach(e => {
            if (e.innerText.indexOf("你需要登录") !== -1)
                e.innerHTML = "尚未登录，请点击<a href='javascript:void(0)' onclick='android.toggleLogin()'>此处</a>登录。"
        })

        try {
            let loadPostList = (page) => {
                loadPage(android.loadPageWithPage(page));
            };
            let pgsBox = cE({type: "div", attr: [["id", "pg-pgs"]]});
            if (curPage !== 1) {
                let firstPage = cE({
                    type: "span",
                    innerText: "first_page",
                    attr: [["class", "page mi"]]
                });
                firstPage.onclick = () => {
                    loadPostList(1)
                };
                pgsBox.append(firstPage);
                let prevPage = cE({
                    type: "span",
                    innerText: "chevron_left",
                    attr: [["class", "page mi"]]
                });
                prevPage.onclick = () => {
                    loadPostList(curPage - 1)
                };
                pgsBox.append(prevPage)
            }
            if (curPage - 1 >= 1) {
                let page = cE({type: "span", innerText: (curPage - 1), attr: [["class", "page"]]});
                page.onclick = () => {
                    loadPostList(curPage - 1)
                };
                pgsBox.append(page)
            }
            pgsBox.append(cE({type: "span", innerText: curPage}));
            if (curPage + 1 <= lastPage) {

                let page = cE({type: "span", innerText: (curPage + 1), attr: [["class", "page"]]});
                page.onclick = () => {
                    loadPostList(curPage + 1)
                };
                pgsBox.append(page)
            }
            if (curPage !== lastPage) {
                let nextPage = cE({
                    type: "span",
                    innerText: "chevron_right",
                    attr: [["class", "page mi"]]
                });
                nextPage.onclick = () => {
                    loadPostList(curPage + 1)
                };
                pgsBox.append(nextPage);
                let lPCont = cE({type: "span", innerText: "last_page", attr: [["class", "page mi"]]});
                lPCont.onclick = () => {
                    loadPostList(lastPage)
                };
                pgsBox.append(lPCont)
            }
            document.body.append(pgsBox)
        } catch (e) {
            console.log(e);
        }
    }
    window.onload = () => {
        loadPage();
        darkMode(android.isDarkMode());
        android.displayWebView();
    };
</script>
</html>